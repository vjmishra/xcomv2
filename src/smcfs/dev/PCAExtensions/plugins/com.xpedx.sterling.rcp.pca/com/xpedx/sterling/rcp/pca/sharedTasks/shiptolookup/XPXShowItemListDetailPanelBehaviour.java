package com.xpedx.sterling.rcp.pca.sharedTasks.shiptolookup;
import java.awt.Color;
import java.awt.font.TextAttribute;
import java.util.ArrayList;
import java.util.HashMap;

import org.eclipse.swt.events.MouseEvent;
import org.eclipse.swt.widgets.Composite;
import org.eclipse.swt.widgets.TableItem;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.NodeList;

import com.xpedx.sterling.rcp.pca.tasks.myitems.screen.XPXMyItemsListDetailsPanelBehavior;
import com.xpedx.sterling.rcp.pca.util.XPXCacheManager;
import com.xpedx.sterling.rcp.pca.util.XPXPaginationBehavior;
import com.yantra.yfc.rcp.YRCApiContext;
import com.yantra.yfc.rcp.YRCPlatformUI;
import com.yantra.yfc.rcp.YRCXmlUtils;
import com.yantra.yfc.rcp.internal.YRCCommand;
import com.yantra.yfc.rcp.internal.YRCCommandRepository;

/**
 * @author Manas
 *
 * Generated by Sterling RCP Tools
 */
public class XPXShowItemListDetailPanelBehaviour extends XPXPaginationBehavior{
	public static final String PAGINATION_STRATEGY_FOR_SEARCH = NEXTPAGE_PAGINATION_STRATEGY;
	private static final String COMMAND_GET_LIST_OF_SHIPTO="XPXGetListOfAssignedShipTosForAUserService";
	private Element elePageInput;
	private XPXShowItemListDetailPanel page;
	public static  HashMap masterUOMList = new HashMap<String, String>();
	public ArrayList itemList = new ArrayList();
	private String itemShortDescription;
	public  HashMap itemDescList = new HashMap<String, String>();
	private Element outItemDetailXml;
	private Element eleMyItemsList;
	/**
	 * Constructor for the behavior class. 
	 * @param elePageInput 
	 */
    public XPXShowItemListDetailPanelBehaviour(Composite ownerComposite, String formId, Element elePageInput) {
        super(ownerComposite, formId);
        this.elePageInput = elePageInput;
        
        this.page = (XPXShowItemListDetailPanel)ownerComposite;
        initPage();
        masterUOMList =XPXMyItemsListDetailsPanelBehavior.masterUOMList;
        
    }
    
	/**
	 * This method initializes the behavior class.
	 */    
	public void initPage() {
		
		if(null != elePageInput){
			YRCApiContext apiCtx = new YRCApiContext();
			String[] apinames = {"getXPEDXMyItemsListDetail"};
			apiCtx.setApiNames(apinames);
			apiCtx.setInputXml(elePageInput.getOwnerDocument());
			apiCtx.setFormId(getFormId());
			callApi(apiCtx);
	}
	}
	@Override
	public void handleApiCompletion(YRCApiContext apiContext) {
		if (apiContext.getInvokeAPIStatus() > 0){
			if (page.isDisposed()) {
				YRCPlatformUI.trace("Page is Disposed");
			} else {
				String[] apinames = apiContext.getApiNames();
				for (int i=0; i<apinames.length; i++) {
					String apiname = apinames[i];
					if(YRCPlatformUI.equals(apiname, "getXPEDXMyItemsListDetail")){
		     			Document docOutput = apiContext.getOutputXmls()[i];
						if (docOutput != null) {
							outItemDetailXml = docOutput.getDocumentElement();
							//For Retrieving Item short description
							eleMyItemsList = YRCXmlUtils.getXPathElement(outItemDetailXml, "/XPEDXMyItemsListList/XPEDXMyItemsList");
							updateModelWithUOMDesc(eleMyItemsList);	
							System.out.println("The API output is:" + YRCXmlUtils.getString(outItemDetailXml));
							
						}
		     		}
					else if ("getCompleteItemList".equals(apiname)) {
						Document docOutput = apiContext.getOutputXmls()[i];
						if (docOutput != null) {
							String itemID = null;
							Element item = docOutput.getDocumentElement();
							Element eleItemsList1 = YRCXmlUtils.getChildElement(item, "Item");
							if (eleItemsList1 != null) {
							itemID = eleItemsList1.getAttribute("ItemID");
							Element primaryInfoElem = YRCXmlUtils.getChildElement(eleItemsList1,"PrimaryInformation");
							if (primaryInfoElem != null) {
								itemShortDescription = primaryInfoElem.getAttribute("ShortDescription");
								itemDescList.put(itemID, primaryInfoElem.getAttribute("ShortDescription"));
							}
							}
							//Time to set the description attribute from the hashmap in a loop
							eleMyItemsList = YRCXmlUtils.getXPathElement(outItemDetailXml, "/XPEDXMyItemsListList/XPEDXMyItemsList");
							Element eleItemsItemsList1 = YRCXmlUtils.getChildElement(eleMyItemsList, "XPEDXMyItemsItemsList");
							ArrayList<Element> listItems1 = YRCXmlUtils.getChildren(eleItemsItemsList1, "XPEDXMyItemsItems");
							for (Element eleItem : listItems1) {								
								String itemsId = eleItem.getAttribute("ItemId");
								if(itemDescList!=null && itemDescList.containsKey(itemsId))
									eleItem.setAttribute("Name", (String) itemDescList.get(itemsId));
							}
							setModel("XPEDXMyItemsListList",outItemDetailXml);
						}
					}
				}
			}
		}
		
	}

	public void mouseDoubleClick(MouseEvent e, String string) {
		TableItem tblItems[] = page.tblResults.getSelection();
        if(tblItems.length > 0)
        	for(int i = 0; i < tblItems.length; i++)
                if(!YRCPlatformUI.isVoid(tblItems[i]) && !tblItems[i].isDisposed())
                {
                	
                	Element eleCustomer = (Element)tblItems[i].getData();
                	
					Element eleAddress = YRCXmlUtils.createDocument("XpedxMilBothLst").getDocumentElement();
					if(!YRCPlatformUI.isVoid(eleCustomer.getAttribute("CustomerContactID")))
						eleAddress.setAttribute("Createuserid", eleCustomer.getAttribute("CustomerContactID"));
                    this.page.eleSelected = eleAddress;
                    
                }
		
	}
	
	public void search() {
		this.getXpxPaginationData().setInputXml(getModel("Input_getAssignedShipToList").getOwnerDocument());
		super.search();
	}

	private void setPaginationDetails(){
		 
        this.getXpxPaginationData().setPaginationStrategy(PAGINATION_STRATEGY_FOR_SEARCH);
        
		YRCCommand command = YRCCommandRepository.getCommand((new StringBuilder()).append(getFormId()).append(COMMAND_GET_LIST_OF_SHIPTO).toString());
		this.getXpxPaginationData().setApiName(command.getCommandAPIName());
		this.getXpxPaginationData().setIsFlow("Y");
		
		//Set the model data. This is a pre-requisite before calling the handlePaginationOutput method
		setSrcModelName("XPXCustomerAssignmentViewList");
		setRootListElemName("XPXCustomerAssignmentViewList");
		setRepeatingElemName("XPXCustomerAssignmentView");
	}
	public void setRepeatingElemName(String repeatingElemName) {
		this.repeatingElemName = repeatingElemName;
	}

	public void setRootListElemName(String rootListElemName) {
		this.rootListElemName = rootListElemName;
	}

	public void setSrcModelName(String srcModelName) {
		this.srcModelName = srcModelName;
	}
	
	private void updateModelWithUOMDesc(Element outXml) {
		Element eleItemsList = YRCXmlUtils.getChildElement(outXml, "XPEDXMyItemsItemsList");
		ArrayList<Element> listItems = YRCXmlUtils.getChildren(eleItemsList, "XPEDXMyItemsItems");
		for (Element eleItem : listItems) {
			itemList.add(eleItem.getAttribute("ItemId"));
		} 
			setModel("getXPEDXMyItemsListDetail",outXml);
		getCompleteItemListAPICall(itemList);
}
	
	 private void getCompleteItemListAPICall(ArrayList itemList){
			
		 for(int i = 0 ; i < itemList.size();i++){
			  YRCApiContext ctx = new YRCApiContext();
				ctx.setApiNames(new String[]{"getCompleteItemList"});
				Document doc = YRCXmlUtils.createFromString("<Item  CallingOrganizationCode='xpedx' ItemID='"+itemList.get(i)+"'  IsForOrdering='N'  />");
				ctx.setInputXml(doc);
				ctx.setFormId(getFormId());
				callApi(ctx, page);
		}
	 }

}


